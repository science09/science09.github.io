<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-notes/wechat/mysql_MVCC_and_its_implementation_principle">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.1.0">
<title data-rh="true">深入理解 MySQL 的 MVCC 及实现原理 | 彼岸_未来</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://science09.github.io/docs/mysql_MVCC_and_its_implementation_principle"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="深入理解 MySQL 的 MVCC 及实现原理 | 彼岸_未来"><meta data-rh="true" name="description" content="MVCC 是 Copy On Write 的思想，MVCC 在无锁的情况下除了支持读和读并行，还支持读和写并行，写和读并行，但为了保证数据的一致性，写和写是无法并行的。"><meta data-rh="true" property="og:description" content="MVCC 是 Copy On Write 的思想，MVCC 在无锁的情况下除了支持读和读并行，还支持读和写并行，写和读并行，但为了保证数据的一致性，写和写是无法并行的。"><link data-rh="true" rel="icon" href="/img/favicon.png"><link data-rh="true" rel="canonical" href="https://science09.github.io/docs/mysql_MVCC_and_its_implementation_principle"><link data-rh="true" rel="alternate" href="https://science09.github.io/docs/mysql_MVCC_and_its_implementation_principle" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://science09.github.io/docs/mysql_MVCC_and_its_implementation_principle" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="彼岸_未来 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="彼岸_未来 Atom Feed"><link rel="stylesheet" href="/assets/css/styles.e07c85a0.css">
<link rel="preload" href="/assets/js/runtime~main.9daf0f53.js" as="script">
<link rel="preload" href="/assets/js/main.d9571267.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,e("light"))}()</script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a href="#" class="skipToContent_fXgn">跳到主要内容</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Logo" class="themedImage_ToTc themedImage--light_HNdA" style="border-radius:70%"><img src="/img/logo.svg" alt="Logo" class="themedImage_ToTc themedImage--dark_i4oU" style="border-radius:70%"></div><b class="navbar__title text--truncate">彼岸_未来</b></a><a class="navbar__item navbar__link" href="/blog">个人笔记</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/notes-intro">技术文摘</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/science09" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/notes-intro">介绍</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/distribute_id_generate">公众号文章</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/distribute_id_generate">分布式唯一ID生成方案</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/how_dose_linux_filesystem_work">Linux文件系统是如何工作的？</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/mysql_MVCC_and_its_implementation_principle">深入理解 MySQL 的 MVCC 及实现原理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/从0.742秒到0.006秒，MySQL百万数据深分页优化实战">从0.742秒到0.006秒，MySQL百万数据深分页优化实战</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/30条永不过时的SQL优化技巧">30条永不过时的SQL优化技巧</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/21个MySQL表设计的经验准则">21个MySQL表设计的经验准则</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/resources-webtool">资源</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/resources-webtool">工具网站列表</a></li></ul></li></ul></nav><button type="button" title="收起侧边栏" aria-label="收起侧边栏" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">公众号文章</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">深入理解 MySQL 的 MVCC 及实现原理</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><h1>1. 概要</h1><blockquote><p>MVCC 是 Copy On Write 的思想，MVCC 在无锁的情况下除了支持读和读并行，还支持读和写并行，写和读并行，但为了保证数据的一致性，写和写是无法并行的。</p></blockquote><p><img loading="lazy" alt="7e4934feb1674779a1eb3ffbe0690f2a~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0" src="/assets/images/9d8083792b332546-f479b58d62b37acb5e071fba5fb34f48.awebp" width="1014" height="531" class="img_ev3q"></p><p>在事务1开始写操作的时候会 copy 一个记录的副本，其他事务读操作会读取这个记录副本，因此不会影响其他事务对此记录的读取，实现写和读并行。</p><p>MVCC 在 MySQL InnoDB 中的实现主要是为了<strong>提高数据库的并发性能</strong>，用更好的方式去处理读-写冲突，做到<strong>即使有读写冲突时，也能做到不加锁，非阻塞并发读</strong>。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="11-什么是-mvcc">1.1 什么是 MVCC<a class="hash-link" href="#11-什么是-mvcc" title="标题的直接链接">​</a></h2><blockquote><p>MVCC，全称 Multi-Version Concurrency Control ，即多版本并发控制。MVCC 是一种并发控制的方法，一般在数据库管理系统中，实现对数据库的并发访问，在编程语言中实现事务内存。 MVCC -
@百度百科</p></blockquote><p>如何生成的多版本？每次事务修改操作之前，都会在 <strong>undo_log</strong> 中记录修改之前的数据状态和事务号，该备份记录可以用于其他事务的读取，也可以进行必要时的数据回滚。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="12-当前读和快照读">1.2 当前读和快照读<a class="hash-link" href="#12-当前读和快照读" title="标题的直接链接">​</a></h2><p>在学习 <strong>MVCC</strong> 多版本并发控制之前，我们必须先了解一下，什么是 <strong>MySQL InnoDB</strong> 下的<strong>当前读</strong>和<strong>快照读</strong>?</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="121-当前读">1.2.1 当前读<a class="hash-link" href="#121-当前读" title="标题的直接链接">​</a></h3><p>像 select lock in share mode (<strong>共享锁</strong>), select for update; update; insert; delete (<strong>排他锁</strong>) 这些操作都是一种当前读，为什么叫当前读？就是它读取的是记录的最新版本，读取时还要保证其他并发事务不能修改当前记录，会对读取的记录进行加锁。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="122-快照读">1.2.2 快照读<a class="hash-link" href="#122-快照读" title="标题的直接链接">​</a></h3><p>不加锁的 select 操作就是快照读，即<strong>不加锁的非阻塞读</strong>，降低数据库的开销。</p><p>快照读的前提是隔离级别<strong>不是串行级别</strong>，串行级别下的快照读会<strong>退化成当前读</strong>。之所以出现快照读的情况，是基于提高并发性能的考虑，<strong>快照读的实现是基于多版本并发控制（MVCC）</strong>。串行化的 SQL 都是排队执行的，不存在并发，所以就会变成当前读。</p><p>我们可以认为 MVCC 是行锁的一个变种，但 MVCC 在很多情况下它避免了加锁，降低了开销，既然是基于多版本的，所以<strong>快照读不一定读到的就是最新版本的记录，而是可能为之前的历史版本</strong>。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="13-当前读快照读和mvcc的关系">1.3 当前读，快照读和MVCC的关系<a class="hash-link" href="#13-当前读快照读和mvcc的关系" title="标题的直接链接">​</a></h2><p>MVCC 多版本并发控制是 <strong>「维持一个数据的多个版本，使得读写操作没有冲突」</strong> 的概念，只是一个抽象概念，并非实现；</p><p>因为 MVCC 只是一个抽象概念，要实现这么一个概念，MySQL 就需要提供具体的功能去实现它，「<strong>快照读就是 MySQL 实现 MVCC 理想模型的其中一个非阻塞读功能」</strong>。而相对而言，当前读就是悲观锁的具体功能实现；</p><p>要说的再细致一些，快照读本身也是一个抽象概念，再深入研究。MVCC 模型在 MySQL 中的具体实现则是由 <strong>3 个隐式字段，undo 日志 ，Read View</strong> 等去完成的，具体可以看下面的 MVCC 实现原理。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="14-mvcc-能解决什么问题好处是">1.4 MVCC 能解决什么问题，好处是？<a class="hash-link" href="#14-mvcc-能解决什么问题好处是" title="标题的直接链接">​</a></h2><ol><li><strong>数据库并发场景有三种，分别为：</strong></li></ol><ul><li><p><code>读-读</code>：不存在任何问题，也不需要并发控制</p></li><li><p><code>读-写</code>：有线程安全问题，可能会造成事务隔离性问题，可能遇到脏读，幻读，不可重复读</p></li><li><p><code>写-写</code>：有线程安全问题，可能会存在更新丢失问题，比如第一类更新丢失，第二类更新丢失</p></li></ul><ol><li><strong>MVCC 带来的好处是？</strong></li></ol><p>多版本并发控制（MVCC）是一种用来解决<code>读-写冲突</code>的<strong>无锁并发控制</strong>，也就是为事务分配单向增长的时间戳，为每个修改保存一个版本，版本与事务时间戳关联，读操作只读该事务开始前的数据库的快照。 所以 MVCC 可以为数据库解决以下问题</p><ul><li><p>在并发读写数据库时，可以做到在读操作时不用阻塞写操作，写操作也不用阻塞读操作，提高了数据库并发读写的性能</p></li><li><p>同时还可以解决脏读，幻读，不可重复读等事务隔离问题，但不能解决更新丢失问题</p></li></ul><ol><li><strong>小结一下咯</strong></li></ol><p>简而言之，MVCC 就是因为大佬们，不满意只让数据库采用悲观锁这样性能不佳的形式去解决读-写冲突问题，而提出的解决方案，所以<strong>在数据库中，因为有了 MVCC，所以我们可以形成两个组合：</strong></p><ul><li><p><code>MVCC + 悲观锁</code>
MVCC解决读写冲突，悲观锁解决写写冲突</p></li><li><p><code>MVCC + 乐观锁</code>
MVCC 解决读写冲突，乐观锁解决写写冲突</p></li></ul><p>这种组合的方式就可以最大程度的提高数据库并发性能，并解决读写冲突，和写写冲突导致的问题</p><h1>2. MVCC实现原理</h1><p>MVCC 的目的就是多版本并发控制，在数据库中的实现，就是为了解决<code>读写冲突</code>，它的实现原理主要是依赖记录中的 <code>**3个隐式字段**</code>，<code>**undo日志**</code> ，<code>**Read View**</code> 来实现的。所以我们先来看看这个三个 point 的概念</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="21-隐式字段">2.1 <strong>隐式字段</strong><a class="hash-link" href="#21-隐式字段" title="标题的直接链接">​</a></h2><p>每行记录除了我们自定义的字段外，还有数据库隐式定义的 <code>DB_TRX_ID</code>, <code>DB_ROLL_PTR</code>, <code>DB_ROW_ID</code> 等字段：</p><ul><li><p><code>DB_TRX_ID</code>
6 byte，最近修改(<code>修改/插入</code>)事务 ID：记录创建这条记录/最后一次修改该记录的事务 ID</p></li><li><p><code>DB_ROLL_PTR</code>
7 byte，回滚指针，指向这条记录的上一个版本（存储于 rollback segment 里）</p></li><li><p><code>DB_ROW_ID</code>
6 byte，隐含的自增 ID（隐藏主键），如果数据表没有主键，InnoDB 会自动以<code>DB_ROW_ID</code>产生一个聚簇索引</p></li><li><p>实际还有一个删除 flag 隐藏字段, 既记录被更新或删除并不代表真的删除，而是删除 flag 变了</p></li></ul><p><img loading="lazy" alt="4d93f688394d4cf8a95433bde0fcde51~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0" src="data:;base64,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" width="927" height="206" class="img_ev3q"></p><p>如上图，<code>DB_ROW_ID</code> 是数据库默认为该行记录生成的唯一隐式主键，<code>DB_TRX_ID</code></p><p>是当前操作该记录的事务 ID ,而 <code>DB_ROLL_PTR</code> 是一个回滚指针，用于配合 undo日志，指向上一个旧版本</p><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="22-undo-log">2.2 <strong>undo log</strong><a class="hash-link" href="#22-undo-log" title="标题的直接链接">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="221-undo-log">2.2.1 undo log<a class="hash-link" href="#221-undo-log" title="标题的直接链接">​</a></h3><p>undo log 主要分为两种：</p><ul><li><strong>insert undo log</strong></li></ul><p>代表事务在 <code>insert</code> 新记录时产生的 <code>undo log</code>, 只在事务回滚时需要，并且在事务提交后可以被立即丢弃</p><ul><li><strong>update undo log</strong></li></ul><p>事务在进行 <code>update</code> 或 <code>delete</code> 时产生的 <code>undo log</code> ; 不仅在事务回滚时需要，在快照读时也需要；所以不能随便删除，只有在快速读或事务回滚不涉及该日志时，对应的日志才会被 <code>purge</code> 线程统一清除</p><blockquote><p>purge：</p></blockquote><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">- 从前面的分析可以看出，为了实现 InnoDB 的 MVCC 机制，更新或者删除操作都只是设置一下老记录的 deleted_bit ，并不真正将过时的记录删除。</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- 为了节省磁盘空间，InnoDB 有专门的 purge 线程来清理 deleted_bit 为 true 的记录。为了不影响 MVCC 的正常工作，purge 线程自己也维护了一个read view（这个 read view 相当于系统中最老活跃事务的 read view ）;如果某个记录的 deleted_bit 为 true ，并且 DB_TRX_ID 相对于 purge 线程的 read view 可见，那么这条记录一定是可以被安全清除的。</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="222-版本链">2.2.2 版本链<a class="hash-link" href="#222-版本链" title="标题的直接链接">​</a></h3><p>对 MVCC 有帮助的实质是 <code>update undo log</code> ，<code>undo log</code> 实际上就是存在 <code>rollback segment</code> 中旧记录链，<strong>它的执行流程如下：</strong></p><p><strong>一、**</strong> 比如一个有个事务插入 persion 表插入了一条新记录，记录如下，<strong>`</strong>name<strong>`</strong> 为 Jerry , <strong>`</strong>age<strong>`</strong> 为 24 岁，<strong>`</strong>隐式主键<strong>`</strong>是 1，<strong>`</strong>事务 ID<strong>`</strong>和<strong>`</strong>回滚指针<strong>`</strong>，我们假设为 NULL**</p><p><img loading="lazy" alt="4dbd0151b6c541198fd188d2aa79b92a~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0" src="data:;base64,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" width="833" height="168" class="img_ev3q"></p><p><strong>二、**</strong> 现在来了一个<strong>`</strong>事务 1<strong>`</strong>对该记录的 <strong>`</strong>name<strong>`</strong> 做出了修改，改为 Tom**</p><ul><li><p>在<code>事务 1</code>修改该行(记录)数据时，数据库会先对该行加<code>排他锁</code></p></li><li><p>然后把该行数据拷贝到 <code>undo log</code> 中，作为旧记录，既在 <code>undo log</code> 中有当前行的拷贝副本</p></li><li><p>拷贝完毕后，修改该行<code>name</code>为Tom，并且修改隐藏字段的事务 ID 为当前<code>事务 1</code>的 ID, 我们默认从 <code>1</code> 开始，之后递增，回滚指针指向拷贝到 <code>undo log</code> 的副本记录，既表示我的上一个版本就是它</p></li><li><p>事务提交后，释放锁</p><p>![ceeb7a9c547144258c31179b58404490~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0../../../static/paper/9a1c5acdf2742d63.awebp)</p></li></ul><p><strong>三、**</strong> 又来了个<strong>`</strong>事务 2<strong>`</strong>修改<strong>`</strong>person 表<strong>`</strong>的同一个记录，将<strong>`</strong>age<strong>`</strong>修改为 30 岁**</p><ul><li><p>在<code>事务2</code>修改该行数据时，数据库也先为该行加锁</p></li><li><p>然后把该行数据拷贝到 <code>undo log</code> 中，作为旧记录，发现该行记录已经有 <code>undo log</code> 了，那么最新的旧数据作为链表的表头，插在该行记录的 <code>undo log</code> 最前面</p></li><li><p>修改该行 <code>age</code> 为 30 岁，并且修改隐藏字段的事务 ID 为当前<code>事务 2</code>的 ID, 那就是 <code>2</code> ，回滚指针指向刚刚拷贝到 <code>undo log</code> 的副本记录</p></li><li><p>事务提交，释放锁</p></li></ul><p><img loading="lazy" alt="6eda09c1d55f42de8dc5f216691a5d46~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0" src="/assets/images/f62782dc95d03a85-ba4ccb536d1370760e310cc96f0ea1e1.awebp" width="838" height="513" class="img_ev3q"></p><p>从上面，我们就可以看出，不同事务或者相同事务的对同一记录的修改，会导致该记录的<code>undo log</code>成为一条记录版本线性表，既链表，<code>undo log</code> 的链首就是最新的旧记录，链尾就是最早的旧记录（<strong>当然就像之前说的该 undo log 的节点可能是会 purge 线程清除掉，向图中的第一条 insert undo log，其实在事务提交之后可能就被删除丢失了，不过这里为了演示，所以还放在这里</strong>）</p><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="23-read-view-读视图">2.3 <strong>Read View 读视图</strong><a class="hash-link" href="#23-read-view-读视图" title="标题的直接链接">​</a></h2><p><strong>什么是 Read View?</strong></p><p>什么是 Read View，说白了 Read View 就是事务进行<code>快照读</code>操作的时候生产的<code>读视图</code> (Read View)，在该事务执行的快照读的那一刻，会生成数据库系统当前的一个快照，记录并维护系统当前活跃事务的 ID (<strong>当每个事务开启时，都会被分配一个 ID , 这个 ID 是递增的，所以最新的事务，ID 值越大</strong>)</p><p>所以我们知道 <code>Read View</code> 主要是用来做可见性判断的, 即当我们某个事务执行快照读的时候，对该记录创建一个 <code>Read View</code> 读视图，把它比作条件用来判断当前事务能够看到哪个版本的数据，既可能是当前最新的数据，也有可能是该行记录的<code>undo log</code>里面的某个版本的数据。</p><p><code>Read View</code>遵循一个可见性算法，主要是将<code>要被修改的数据</code>的最新记录中的 <code>DB_TRX_ID</code>（即当前事务 ID ）取出来，与系统当前其他活跃事务的 ID 去对比（由 Read View 维护），如果 <code>DB_TRX_ID</code> 跟 Read View 的属性做了某些比较，不符合可见性，那就通过 <code>DB_ROLL_PTR</code> 回滚指针去取出 <code>Undo Log</code> 中的 <code>DB_TRX_ID</code> 再比较，即遍历链表的 <code>DB_TRX_ID</code>（从链首到链尾，即从最近的一次修改查起），直到找到满足特定条件的 <code>DB_TRX_ID</code> , <strong>那么这个 DB_TRX_ID 所在的旧记录就是当前事务能看见的最新</strong><code>**老版本**</code></p><p><strong>那么这个判断条件是什么呢？</strong></p><p><img loading="lazy" alt="e5ac165372f1448caf56938408b2eb32~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0" src="/assets/images/b830e11fb5a33e38-9a552fca44c41a0aba98c80f040dbfb0.awebp" width="720" height="632" class="img_ev3q"></p><p>我们这里盗窃</p><p><a href="https://link.juejin.cn/?target=https%3A%2F%2Fwww.zhihu.com%2Fquestion%2F66320138%2Fanswer%2F241418502" target="_blank" rel="noopener noreferrer">@呵呵一笑百媚生</a></p><p>一张源码图，如上，它是一段 MySQL 判断可见性的一段源码，即 <code>changes_visible</code> 方法（<strong>不完全哈，但能看出大致逻辑</strong>），该方法展示了我们拿 DB_TRX_ID 去跟 Read View 某些属性进行怎么样的比较</p><p>在展示之前，我先简化一下 Read View，我们可以把 Read View 简单的理解成有三个全局属性</p><blockquote><p>trx_list（名称我随意取的）
一个数值列表用于维护 Read View 生成时刻系统 正活跃的事务 ID 列表up_limit_idlower water remark是 trx_list 列表中事务 ID 最小的 IDlow_limit_idhight water markReadView 生成时刻系统尚未分配的下一个事务 ID ，也就是 目前已出现过的事务 ID 的最大值 + 1为什么是 low_limit ? 因为它也是系统此刻可分配的事务 ID 的最小值</p></blockquote><ul><li><p>首先比较 <code>DB_TRX_ID &lt; up_limit_id</code> , 如果小于，则当前事务能看到 <code>DB_TRX_ID</code> 所在的记录，如果大于等于进入下一个判断</p></li><li><p>接下来判断 <code>DB_TRX_ID &gt;= low_limit_id</code> , 如果大于等于则代表 <code>DB_TRX_ID</code> 所在的记录在 <code>Read View</code> 生成后才出现的，那对当前事务肯定不可见，如果小于则进入下一个判断</p></li><li><p>判断 <code>DB_TRX_ID</code> 是否在活跃事务之中，<code>trx_list.contains (DB_TRX_ID)</code>，如果在，则代表我 <code>Read View</code> 生成时刻，你这个事务还在活跃，还没有 Commit，你修改的数据，我当前事务也是看不见的；如果不在，则说明，你这个事务在 <code>Read View</code> 生成之前就已经 Commit 了，你修改的结果，我当前事务是能看见的</p></li></ul><hr><h2 class="anchor anchorWithStickyNavbar_LWe7" id="24-整体流程">2.4 整体流程<a class="hash-link" href="#24-整体流程" title="标题的直接链接">​</a></h2><p>我们在了解了 <code>隐式字段</code>，<code>undo log</code>， 以及 <code>Read View</code> 的概念之后，就可以来看看 MVCC 实现的整体流程是怎么样了</p><p><strong>整体的流程是怎么样的呢？我们可以模拟一下</strong></p><ul><li><p>当<code>事务 2</code>对某行数据执行了<code>快照读</code>，数据库为该行数据生成一个<code>Read View</code>读视图，假设当前事务 ID 为 <code>2</code>，此时还有<code>事务1</code>和<code>事务3</code>在活跃中，<code>事务 4</code>在<code>事务 2</code>快照读前一刻提交更新了，所以 Read View 记录了系统当前活跃事务 1，3 的 ID，维护在一个列表上，假设我们称为<code>trx_list</code></p><table><thead><tr><th>事务 1</th><th>事务 2</th><th>事务 3</th><th>事务 4</th></tr></thead><tbody><tr><td>事务开始</td><td>事务开始</td><td>事务开始</td><td>事务开始</td></tr><tr><td>…</td><td>…</td><td>…</td><td>修改且已提交</td></tr><tr><td>进行中</td><td>进行中</td><td>进行中</td><td></td></tr><tr><td>…</td><td>…</td><td>…</td><td></td></tr></tbody></table></li><li><p>Read View 不仅仅会通过一个列表 <code>trx_list</code> 来维护<code>事务 2</code>执行<code>快照读</code>那刻系统正活跃的事务 ID 列表，还会有两个属性 <code>up_limit_id</code>（ <strong>trx_list 列表中事务 ID 最小的 ID</strong> ），<code>low_limit_id</code> ( <strong>快照读时刻系统尚未分配的下一个事务 ID ，也就是目前已出现过的事务ID的最大值 + 1</strong> <a href="https://link.juejin.cn/?target=https%3A%2F%2Fwww.zhihu.com%2Fquestion%2F66320138%2Fanswer%2F241418502" target="_blank" rel="noopener noreferrer">资料传送门 | 呵呵一笑百媚生的回答</a> ) 。所以在这里例子中 <code>up_limit_id</code> 就是1，<code>low_limit_id</code> 就是 4 + 1 = 5，trx_list 集合的值是 1, 3，<code>Read View</code> 如下图</p></li></ul><p><img loading="lazy" alt="c69f16d8f3c04012b6e79d8b01030168~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0" src="data:;base64,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" width="696" height="151" class="img_ev3q"></p><ul><li>我们的例子中，只有<code>事务 4</code> 修改过该行记录，并在<code>事务 2</code> 执行<code>快照读</code>前，就提交了事务，所以当前该行当前数据的 <code>undo log</code> 如下图所示；我们的事务 2 在快照读该行记录的时候，就会拿该行记录的 <code>DB_TRX_ID</code> 去跟 <code>up_limit_id</code> , <code>low_limit_id</code> 和<code>活跃事务 ID 列表( trx_list )</code>进行比较，判断当前<code>事务 2</code>能看到该记录的版本是哪个。</li></ul><p><img loading="lazy" alt="e552a8ad86424cb285a4bc02c7908bf4~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0" src="/assets/images/7325baf3ee1f506e-67f6c343fda95f309e7d8f4416557265.awebp" width="761" height="338" class="img_ev3q"></p><ul><li>所以先拿该记录 <code>DB_TRX_ID</code> 字段记录的事务 ID <code>4</code> 去跟 <code>Read View</code> 的 <code>up_limit_id</code> 比较，看 <code>4</code> 是否小于 <code>up_limit_id</code>( 1 )，所以不符合条件，继续判断 <code>4</code> 是否大于等于 <code>low_limit_id</code>( 5 )，也不符合条件，最后判断 <code>4</code> 是否处于 <code>trx_list</code> 中的活跃事务, 最后发现事务 ID 为 <code>4</code> 的事务不在当前活跃事务列表中, 符合可见性条件，所以<code>事务 4</code>修改后提交的最新结果对<code>事务 2</code> 快照读时是可见的，所以<code>事务 2</code> 能读到的最新数据记录是<code>事务4</code>所提交的版本，而事务4提交的版本也是全局角度上最新的版本</li></ul><p><img loading="lazy" alt="2c9aa0aaa9ce496f9510cd8c1d921ece~tplv-k3u1fbpfcp-zoom-in-crop-mark:3024:0:0:0" src="/assets/images/f4329e9aff3905f4-f85b904c1e7f86d1addde6e1960a8dac.awebp" width="1647" height="1141" class="img_ev3q"></p><ul><li>也正是 Read View 生成时机的不同，从而造成 RC , RR 级别下快照读的结果的不同</li></ul><h1>3. MVCC 相关问题</h1><h2 class="anchor anchorWithStickyNavbar_LWe7" id="31-rr-是如何在-rc-级的基础上解决不可重复读的">3.1 RR 是如何在 RC 级的基础上解决不可重复读的？<a class="hash-link" href="#31-rr-是如何在-rc-级的基础上解决不可重复读的" title="标题的直接链接">​</a></h2><p><strong>当前读和快照读在 RR 级别下的区别：</strong></p><p><code>表1:</code></p><table><thead><tr><th>事务A</th><th>事务B</th></tr></thead><tbody><tr><td>开启事务</td><td>开启事务</td></tr><tr><td>快照读(无影响)查询金额为500</td><td>快照读查询金额为500</td></tr><tr><td>更新金额为400</td><td></td></tr><tr><td>提交事务</td><td></td></tr><tr><td></td><td>select <code>快照读</code>金额为500</td></tr><tr><td></td><td>select lock in share mode<code>当前读</code>金额为400</td></tr></tbody></table><p>在上表的顺序下，事务 B 的在事务 A 提交修改后的快照读是旧版本数据，而当前读是实时新数据 400</p><p><code>表2:</code></p><table><thead><tr><th>事务A</th><th>事务B</th></tr></thead><tbody><tr><td>开启事务</td><td>开启事务</td></tr><tr><td>快照读（无影响）查询金额为500</td><td></td></tr><tr><td>更新金额为400</td><td></td></tr><tr><td>提交事务</td><td></td></tr><tr><td></td><td>select <code>快照读</code>金额为400</td></tr><tr><td></td><td>select lock in share mode<code>当前读</code>金额为400</td></tr></tbody></table><p>而在<code>表 2</code>这里的顺序中，事务 B 在事务 A 提交后的快照读和当前读都是实时的新数据 400，这是为什么呢？</p><ul><li>这里与上表的唯一区别仅仅是<code>表 1</code>的事务 B 在事务 A 修改金额前<code>快照读</code>过一次金额数据，而<code>表 2</code>的事务B在事务A修改金额前没有进行过快照读。</li></ul><p><strong>所以我们知道事务中快照读的结果是非常依赖该事务首次出现快照读的地方，即某个事务中首次出现快照读的地方非常关键，它有决定该事务后续快照读结果的能力</strong></p><p><strong>我们这里测试的是</strong><code>**更新**</code><strong>，同时</strong><code>**删除**</code><strong>和</strong><code>**更新**</code><strong>也是一样的，如果事务B的快照读是在事务A操作之后进行的，事务B的快照读也是能读取到最新的数据的</strong></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="32-rc--rr-级别下的-innodb-快照读有什么不同">3.2 RC , RR 级别下的 InnoDB 快照读有什么不同？<a class="hash-link" href="#32-rc--rr-级别下的-innodb-快照读有什么不同" title="标题的直接链接">​</a></h2><p>正是 <code>Read View</code> 生成时机的不同，从而造成 RC , RR 级别下快照读的结果的不同</p><ul><li><p>在 RR 级别下的某个事务的对某条记录的第一次快照读会创建一个快照及 Read View, 将当前系统活跃的其他事务记录起来，此后在调用快照读的时候，还是使用的是同一个 Read View，所以只要当前事务在其他事务提交更新之前使用过快照读，那么之后的快照读使用的都是同一个 Read View，所以对之后的修改不可见；</p></li><li><p>即 RR 级别下，快照读生成 Read View 时，Read View 会记录此时所有其他活动事务的快照，这些事务的修改对于当前事务都是不可见的。而早于Read View创建的事务所做的修改均是可见</p></li><li><p>而在 RC 级别下的，事务中，每次快照读都会新生成一个快照和 Read View , 这就是我们在 RC 级别下的事务中可以看到别的事务提交的更新的原因</p></li></ul><br><p><strong>总之在 RC 隔离级别下，是每个快照读都会生成并获取最新的 Read View；而在 RR 隔离级别下，则是同一个事务中的第一个快照读才会创建 Read View, 之后的快照读获取的都是同一个 Read View。</strong></p><br><p><strong>链接</strong>：<a href="https://juejin.cn/post/7138391470666416164" target="_blank" rel="noopener noreferrer">https://juejin.cn/post/7138391470666416164</a></p><br></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/science09/science09.github.io/tree/main/docs/notes/wechat/mysql_MVCC_and_its_implementation_principle.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">最后<!-- -->由 <b>zhaofeng.luo</b> <!-- -->更新</span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文档分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/how_dose_linux_filesystem_work"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">Linux文件系统是如何工作的？</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/从0.742秒到0.006秒，MySQL百万数据深分页优化实战"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">从0.742秒到0.006秒，MySQL百万数据深分页优化实战</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#11-什么是-mvcc" class="table-of-contents__link toc-highlight">1.1 什么是 MVCC</a></li><li><a href="#12-当前读和快照读" class="table-of-contents__link toc-highlight">1.2 当前读和快照读</a><ul><li><a href="#121-当前读" class="table-of-contents__link toc-highlight">1.2.1 当前读</a></li><li><a href="#122-快照读" class="table-of-contents__link toc-highlight">1.2.2 快照读</a></li></ul></li><li><a href="#13-当前读快照读和mvcc的关系" class="table-of-contents__link toc-highlight">1.3 当前读，快照读和MVCC的关系</a></li><li><a href="#14-mvcc-能解决什么问题好处是" class="table-of-contents__link toc-highlight">1.4 MVCC 能解决什么问题，好处是？</a></li><li><a href="#21-隐式字段" class="table-of-contents__link toc-highlight">2.1 <strong>隐式字段</strong></a></li><li><a href="#22-undo-log" class="table-of-contents__link toc-highlight">2.2 <strong>undo log</strong></a><ul><li><a href="#221-undo-log" class="table-of-contents__link toc-highlight">2.2.1 undo log</a></li><li><a href="#222-版本链" class="table-of-contents__link toc-highlight">2.2.2 版本链</a></li></ul></li><li><a href="#23-read-view-读视图" class="table-of-contents__link toc-highlight">2.3 <strong>Read View 读视图</strong></a></li><li><a href="#24-整体流程" class="table-of-contents__link toc-highlight">2.4 整体流程</a></li><li><a href="#31-rr-是如何在-rc-级的基础上解决不可重复读的" class="table-of-contents__link toc-highlight">3.1 RR 是如何在 RC 级的基础上解决不可重复读的？</a></li><li><a href="#32-rc--rr-级别下的-innodb-快照读有什么不同" class="table-of-contents__link toc-highlight">3.2 RC , RR 级别下的 InnoDB 快照读有什么不同？</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">本站</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">个人笔记</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/notes-intro">技术文摘</a></li></ul></div><div class="col footer__col"><div class="footer__title">我的</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/science09" target="_blank" rel="noopener noreferrer" class="footer__link-item">Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">更多</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/">...</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">版权所有 © 2022  此网站使用 Docusaurus 构建。</div></div></div></footer></div>
<script src="/assets/js/runtime~main.9daf0f53.js"></script>
<script src="/assets/js/main.d9571267.js"></script>
</body>
</html>