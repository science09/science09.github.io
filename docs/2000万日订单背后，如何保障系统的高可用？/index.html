<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-notes/wechat/2000万日订单背后，如何保障系统的高可用？">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.1.0">
<title data-rh="true">2000万日订单背后，如何保障系统的高可用？ | 彼岸_未来</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://science09.github.io/docs/2000万日订单背后，如何保障系统的高可用？"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="2000万日订单背后，如何保障系统的高可用？ | 彼岸_未来"><meta data-rh="true" name="description" content="美团外卖从 2013 年 11 月开始起步，经过数年的高速发展，一直在不断地刷新着记录。2018 年 5 月 19 日，日订单量峰值突破 2000 万单，已经成为全球规模最大的外卖平台。"><meta data-rh="true" property="og:description" content="美团外卖从 2013 年 11 月开始起步，经过数年的高速发展，一直在不断地刷新着记录。2018 年 5 月 19 日，日订单量峰值突破 2000 万单，已经成为全球规模最大的外卖平台。"><link data-rh="true" rel="icon" href="/img/favicon.png"><link data-rh="true" rel="canonical" href="https://science09.github.io/docs/2000万日订单背后，如何保障系统的高可用？"><link data-rh="true" rel="alternate" href="https://science09.github.io/docs/2000万日订单背后，如何保障系统的高可用？" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://science09.github.io/docs/2000万日订单背后，如何保障系统的高可用？" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="彼岸_未来 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="彼岸_未来 Atom Feed"><link rel="stylesheet" href="/assets/css/styles.e07c85a0.css">
<link rel="preload" href="/assets/js/runtime~main.b8772c3e.js" as="script">
<link rel="preload" href="/assets/js/main.6900f799.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,e("light"))}()</script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a href="#" class="skipToContent_fXgn">跳到主要内容</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Logo" class="themedImage_ToTc themedImage--light_HNdA" style="border-radius:70%"><img src="/img/logo.svg" alt="Logo" class="themedImage_ToTc themedImage--dark_i4oU" style="border-radius:70%"></div><b class="navbar__title text--truncate">彼岸_未来</b></a><a class="navbar__item navbar__link" href="/blog">个人笔记</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/notes-intro">技术文摘</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/science09" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/notes-intro">介绍</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/分布式唯一 ID 生成方案">公众号文章</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/分布式唯一 ID 生成方案">分布式唯一 ID 生成方案</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/how_dose_linux_filesystem_work">Linux文件系统是如何工作的？</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/mysql_MVCC_and_its_implementation_principle">深入理解 MySQL 的 MVCC 及实现原理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/从0.742秒到0.006秒，MySQL百万数据深分页优化实战">从0.742秒到0.006秒，MySQL百万数据深分页优化实战</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/30条永不过时的SQL优化技巧">30条永不过时的SQL优化技巧</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/21个MySQL表设计的经验准则">21个MySQL表设计的经验准则</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/MySQL的普通索引和唯一索引到底什么区别？">MySQL的普通索引和唯一索引到底什么区别？</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/图文结合！Redis延迟队列golang高效实践">图文结合！Redis延迟队列golang高效实践</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/3种方式！Go Error处理最佳实践">3种方式！Go Error处理最佳实践</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/推荐系统 embedding 技术实践总结">推荐系统 embedding 技术实践总结</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Go几个黑魔法技巧汇总">Go几个黑魔法技巧汇总</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Redis详细介绍一篇就够">Redis详细介绍一篇就够</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/快速实现一个分布式定时器">快速实现一个分布式定时器</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/如何做架构设计和评审">如何做架构设计和评审</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/面试官：为什么说mysql数据库单表最大两千万？">面试官：为什么说mysql数据库单表最大两千万？</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/【系统设计】S3 对象存储">【系统设计】S3 对象存储</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/B站在全链路压测上的实践">B站在全链路压测上的实践</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/小红书KV存储架构：万亿级数据与跨云多活不在话下">小红书KV存储架构：万亿级数据与跨云多活不在话下</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/网易严选商品中心DDD实践">网易严选商品中心DDD实践</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/社区点赞业务缓存设计优化探索 ｜ 得物技术">社区点赞业务缓存设计优化探索 ｜ 得物技术</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/缓存高频面试题：缓存穿透？缓存击穿？缓存雪崩？">缓存高频面试题：缓存穿透？缓存击穿？缓存雪崩？</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/十几亿用户中心系统，ES+Redis+MySQL架构就轻松搞定！">十几亿用户中心系统，ES+Redis+MySQL架构就轻松搞定！</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/京东售后系统架构设计：专治多端并发、数据不一致的臭毛病">京东售后系统架构设计：专治多端并发、数据不一致的臭毛病</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/2000万日订单背后，如何保障系统的高可用？">2000万日订单背后，如何保障系统的高可用？</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Docker 网络4种模式详解">Docker 网络4种模式详解</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/去哪儿网业务缓存体系的升级改造">去哪儿网业务缓存体系的升级改造</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/架构师技术路线图">架构师技术路线图</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/10年后，再审视Heroku发布的十二要素应用">10年后，再审视Heroku发布的十二要素应用</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/互联网公司常用分库分表方案汇总">互联网公司常用分库分表方案汇总</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/resources-webtool">资源</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/resources-webtool">工具网站列表</a></li></ul></li></ul></nav><button type="button" title="收起侧边栏" aria-label="收起侧边栏" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">公众号文章</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">2000万日订单背后，如何保障系统的高可用？</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>2000万日订单背后，如何保障系统的高可用？</h1></header><br><blockquote><p>美团外卖从 2013 年 11 月开始起步，经过数年的高速发展，一直在不断地刷新着记录。2018 年 5 月 19 日，日订单量峰值突破 2000 万单，已经成为全球规模最大的外卖平台。</p></blockquote><br><p>业务的快速发展对系统稳定性提出了更高的要求，如何为线上用户提供高稳定的服务体验，保障全链路业务和系统高可用运行，不仅需要后端服务支持，更需要在端上提供全面的技术保障。</p><p>而相对服务端而言，客户端运行环境千差万别，不可控因素多，面对突发问题应急能力差。</p><p>因此，构建客户端的高可用建设体系，保障服务稳定高可用，不仅是对工程师的技术挑战，也是外卖平台的核心竞争力之一。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="高可用建设体系的思路">高可用建设体系的思路<a class="hash-link" href="#高可用建设体系的思路" title="标题的直接链接">​</a></h2><p>一个设计良好的大型客户端系统往往是由一系列各自独立的小组共同开发完成的，每一个小组都应当具有明确定义的的职责划分。</p><p>各业务模块之间推行“松耦合”开发模式，让业务模块拥有隔离式变更的能力，是一种可以同时提升开发灵活性和系统健壮性的有效手段。</p><p>下面是美团外卖整体的业务架构，以商品交易链路（门店召回，商品展示，交易）为核心方向进行建设，局部上依据业务特点和团队分工分成多个可独立运维单元单独维护。</p><p>可独立运维单元的简单性是可靠性的前提条件，这使得我们能够持续关注功能迭代，不断完成相关的工程开发任务。</p><p><img loading="lazy" alt="Untitled" src="/assets/images/3b306c31148a4963-ed947619aee8c6a8c9d3d7984b6dc80c.png" width="1080" height="736" class="img_ev3q"></p><p><strong>我们将问题依照生命周期划分为三个阶段：</strong>发现、定位、解决，围绕这三个阶段的持续建设，构成了美团外卖高可用建设体系的核心。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="美团外卖质量保障体系全景图">美团外卖质量保障体系全景图<a class="hash-link" href="#美团外卖质量保障体系全景图" title="标题的直接链接">​</a></h2><p>这是美团外卖客户端整体质量体系全景图。整体思路：监控报警，日志体系，容灾。</p><p><img loading="lazy" alt="Untitled" src="/assets/images/2a45233480b8ea11-e06f3f9f698e47e9056291be6d8b3ad8.png" width="1080" height="528" class="img_ev3q"></p><p>通过采集业务稳定性，基础能力稳定性，性能稳定性三大类指标数据并上报，使得衡量客户端系统质量的标准得以完善。</p><p>通过设立基线，应用特定业务模型对这一系列指标进行监控报警，客户端具备了分钟级感知核心链路稳定性的能力。</p><p>而通过搭建日志体系，整个系统有了提取关键线索能力，多维度快速定位问题。</p><p>当问题一旦定位，我们就能通过美团外卖的线上运维规范进行容灾操作：降级，切换通道或限流，从而保证整体的核心链路稳定性。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="背景监控报警">背景监控&amp;报警<a class="hash-link" href="#背景监控报警" title="标题的直接链接">​</a></h2><p>监控系统，处于整个服务可靠度层级模型的最底层，是运维一个可靠的稳定系统必不可少的重要组成部分。</p><p>为了保障全链路业务和系统高可用运行，需要在用户感知问题之前发现系统中存在的异常，离开了监控系统，我们就没有能力分辨客户端是不是在正常提供服务。</p><p><img loading="lazy" alt="Untitled" src="/assets/images/f7f9b0438de42ed3-842170f46e1b15847266318b498df2ff.png" width="500" height="338" class="img_ev3q"></p><p>按照监控的领域方向，可以分成系统监控与业务监控：</p><ul><li><p><strong>系统监控，</strong>主要用于基础能力如端到端成功率，服务响应时长，网络流量，硬件性能等相关的监控。</p><p>系统监控侧重在无业务侵入和定制系统级别的监控，更多侧重在业务应用的底层，多属于单系统级别的监控。</p></li><li><p><strong>业务监控，</strong>侧重在某个时间区间，业务的运行情况分析。业务监控系统构建于系统监控之上，可以基于系统监控的数据指标计算，并基于特定的业务介入，实现多系统之间的数据联合与分析，并根据相应的业务模型，提供实时的业务监控与告警。</p></li></ul><p>按照业务监控的时效性，可以继续将其细分成实时业务监控与离线业务监控。</p><ul><li><p><strong>实时业务监控，</strong>通过实时的数据采集分析，帮助快速发现及定位线上问题，提供告警机制及介入响应（人工或系统）途径，帮助避免发生系统故障。</p></li><li><p><strong>离线的业务监控，</strong>对一定时间段收集的数据进行数据挖掘、聚合、分析，推断出系统业务可能存在的问题，帮助进行业务上的重新优化或改进的监控。</p></li></ul><p>美团外卖的业务监控，大部分属于实时业务监控。借助美团统一的系统监控建设基础，美团外卖联合公司其他部门将部分监控基础设施进行了改造、共建和整合复用，并打通形成闭环（监控，日志，回捞）。</p><p>我们构建了特定符合外卖业务流程的实时业务监控，而离线的业务监控，主要通过用户行为的统计与业务数据的挖掘分析，来帮助产品设计，运营策略行为等产生影响。目前这部分监控主要由美团外卖数据组提供服务。</p><p>值得特别说明的是单纯的信息汇总展示，无需或无法立即做出介入动作的业务监控，可以称之为业务分析。</p><p>如特定区域的活动消费情况、区域订单数量、特定路径转换率、曝光点击率等，除非这些数据用来决策系统实时状态健康情况，帮助产生系统维护行为，否则这部分监控由离线来处理更合适。</p><p><img loading="lazy" alt="Untitled" src="/assets/images/ab851d0deec3ec55-facb0e2d2bd00cf3a0b607b767474a99.png" width="1080" height="944" class="img_ev3q"></p><p>我们把客户端稳定性指标分为 3 类维度：</p><ul><li><p><strong>业务稳定性指标</strong></p></li><li><p><strong>基础能力稳定性指标</strong></p></li><li><p><strong>性能稳定性指标</strong></p></li></ul><p>对不同的指标，我们采用不同的采集方案进行提取上报，汇总到不同系统；在设定完指标后，我们就可以制定基线，并依照特定的业务模型制定报警策略。</p><p>美团外卖客户端拥有超过 40 项度量质量指标，其中 25 项指标支持分钟级别报警。</p><p>报警通道依据紧急程度支持邮件，IM 和短信三条通道。因此，我们团队具备及时发现影响核心链路稳定性的关键指标变化能力。</p><p>一个完善的监控报警系统是非常复杂的，因此在设计时一定要追求简化。以下是《Site Reliability Engineering：How Google Runs Production Systems》一书中提到的告警设置原则：</p><p><code>*最能反映真实故障的规则应该可预测性强，非常可靠，并且越简单越好*</code></p><p><code>*不常用的数据采集，汇总以及告警配置应该定时清除（某些 SRE 团队的标准是一季度未使用即删除）*</code></p><p><code>*没有暴露给任何监控后台、告警规则的采集数据指标应该定时清除*</code></p><br><p><strong>通过监控&amp;报警系统，2017 年下半年美团外卖客户端团队共发现影响核心链路稳定性超过 20 起问题：</strong>包括爬虫、流量、运营商 403 问题、性能问题等。目前，所有问题均已全部改造完毕。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="日志体系">日志体系<a class="hash-link" href="#日志体系" title="标题的直接链接">​</a></h2><p>监控系统的一个重要特征是生产紧急告警。一旦出现故障，需要有人来调查这项告警，以决定目前是否存在真实故障，是否需要采取特定方法缓解故障，直至查出导致故障的问题根源。</p><p>简单定位和深入调试的过程必须要保持非常简单，必须能够被团队中任何一个人所理解。日志体系，在简化这一过程中起到了决定性作用。</p><p><img loading="lazy" alt="Untitled" src="/assets/images/1cf93bbdb890ee1e-05c26eb19af0d62be5cb2641f397259e.png" width="1080" height="684" class="img_ev3q"></p><p>美团外卖的日志体系总体分为 3 大类：</p><ul><li><p><strong>全量日志系统，</strong>主要负责采集整体性指标，如网络可用性，埋点可用性。我们可以通过它了解到系统整体大盘，了解整体波动，确定问题影响范围。</p></li><li><p><strong>个体日志系统，</strong>用于提取个体用户的关键信息，从而针对性的分析特定客诉问题。</p></li><li><p><strong>异常日志系统，</strong>主要采集异常指标，如大图问题，分享失败，定位失败等。我们通过它可以迅速获取异常上下文信息，分析解决问题。</p></li></ul><p>这三类日志，构成了完整的客户端日志体系。</p><p><img loading="lazy" alt="Untitled" src="/assets/images/7dd340b574016477-5ac98cb8e0f0f5ce1fa8177abcf85f27.png" width="1080" height="413" class="img_ev3q"></p><p>日志的一个典型使用场景是处理单点客诉问题，解决系统潜在隐患。个体日志系统，用于简化工程师提取关键线索步骤，提升定位分析问题效率。在这一领域，美团外卖使用的是点评平台开发的 Logan 服务。</p><p>作为美团移动端底层的基础日志库，Logan 接入了集团众多日志系统，例如端到端日志、用户行为日志、代码级日志、崩溃日志等。</p><p>并且这些日志全部都是本地存储，且有多重加密机制和严格的权限审核机制，在处理用户客诉时才对数据进行回捞和分析，保证用户隐私安全。</p><p>通过设计和实施美团外卖核心链路日志方案，我们打通了用户交易流程中各系统如订单，用户中心，Crash 平台与 Push 后台之间的底层数据同步。</p><p>通过输出标准问题分析手册，针对常见个体问题的分析和处理得以标准化；通过制定日志捞取 SOP 并定期演练，线上追溯能力大幅提升，日常客诉绝大部分可在 30 分钟内定位原因。</p><p>在这一过程中，通过个体暴露出影响核心链路稳定性的问题也均已全部改进/修复。</p><p>故障排查是运维大型系统的一项关键技能。采用系统化的工具和手段而不仅仅依靠经验甚至运气，这项技能是可以自我学习，也可以内部进行传授。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="容灾备份">容灾备份<a class="hash-link" href="#容灾备份" title="标题的直接链接">​</a></h2><p>针对不同级别的服务，应该采取不同的手段进行有效止损。非核心依赖，通过降级向用户提供可伸缩的服务。</p><p>而核心依赖，采用多通道方式进行依赖备份容灾，保证交易路径链路的高可用；异常流量，通过多维度限流，最大限度保证业务可用性的同时，给予用户良好的体验。</p><p><strong>总结成三点，即：非核心依赖降级、核心依赖备份、过载保护限流。接下来我们分别来阐述这三方面。</strong></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="降级"><strong>降级</strong><a class="hash-link" href="#降级" title="标题的直接链接">​</a></h3><p>在这里选取美团外卖客户端整体系统结构关系图来介绍非核心依赖降级建设概览。</p><p><img loading="lazy" alt="Untitled" src="/assets/images/78b621535b6371e7-5c9dd11c4eca0bfb1205c27d36afd2bc.png" width="1080" height="487" class="img_ev3q"></p><p>图上中间红色部分是核心关键节点，即外卖业务的核心链路：定位，商家召回，商品展示，下单；蓝色部分，是核心链路依赖的关键服务；黄色部分，是可降级服务。</p><p>我们通过梳理依赖关系，改造前后端通讯协议，实现了客户端非核心依赖可降级。</p><p>而后端服务，通过各级缓存，屏蔽隔离策略，实现了业务模块内部可降级，业务之间可降级。这构成了美团外卖客户端整体的降级体系。</p><p>右边则是美团外卖客户端业务/技术降级开关流程图。通过推拉结合，缓存更新策略，我们能够分钟级别同步降级配置，快速止损。</p><p>目前，美团外卖客户端有超过 20 项业务/能力支持降级。通过有效降级，我们避开了 1 次 S2 级事故，多次 S3、S4 级事故。</p><p>此外，降级开关整体方案产出 SDK horn，推广至集团酒旅、金融等其他核心业务应用。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="备份"><strong>备份</strong><a class="hash-link" href="#备份" title="标题的直接链接">​</a></h3><p>核心依赖备份建设上，在此重点介绍美团外卖多网络通道。网络通道，作为客户端的最核心依赖，却是整个全链路体系最不可控的部分，经常出现问题。</p><p>网络劫持，运营商故障，甚至光纤被物理挖断等大大小小的故障严重影响了核心链路的稳定性。因此，治理网络问题，必须要建设可靠的多通道备份。</p><p><img loading="lazy" alt="Untitled" src="/assets/images/93f9115284a4986b-0cb265021b1049933c12151a52169592.png" width="1080" height="570" class="img_ev3q"></p><p>这是美团外卖多网络通道备份示意图。美团外卖客户端拥有 Shark、HTTP、HTTPS、HTTP DNS 四条网络通道：整体网络以 Shark 长连通道为主通道，其余三条通道作为备份通道。</p><p>配合完备的开关切换流程，可以在网络指标发生骤降时，实现分钟级别的分城市网络通道切换。</p><p>而通过制定故障应急 SOP 并不断演练，提升了我们解决问题的能力和速度，有效应对各类网络异常。我们的网络通道开关思路也输出至集团其他部门，有效支持了业务发展。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="限流"><strong>限流</strong><a class="hash-link" href="#限流" title="标题的直接链接">​</a></h3><p>服务过载是另一类典型的事故。究其原因大部分情况下都是由于少数调用方调用的少数接口性能很差，导致对应服务的性能恶化。</p><p>若调用端缺乏有效降级容错，在某些正常情况下能够降低错误率的手段，如请求失败后重试，反而会让服务进一步性能恶化，甚至影响本来正常的服务调用。</p><p>美团外卖业务在高峰期订单量已达到了相当高的规模量级，业务系统也极其复杂。</p><p>根据以往经验，在业务高峰期，一旦出现异常流量疯狂增长从而导致服务器宕机，则损失不可估量。</p><p>因此，美团外卖前后端联合开发了一套“流量控制系统”，对流量实施实时控制。</p><p>这样既能日常保证业务系统稳定运转，也能在业务系统出现问题的时候提供一套优雅的降级方案，最大限度保证业务的可用性，在将损失降到最低的前提下，给予用户良好的体验。</p><p><img loading="lazy" alt="Untitled" src="/assets/images/1b9a7f257184e8dd-6df7a01f09bc2571ca6f71016fcd5544.png" width="1080" height="841" class="img_ev3q"></p><p>整套系统，后端服务负责识别打标分类，通过统一的协议告诉前端所标识类别。</p><p>而前端，通过多级流控检查，对不同流量进行区分处理：弹验证码，或排队等待，或直接处理，或直接丢弃。</p><p>面对不同场景，系统支持多级流控方案，可有效拦截系统过载流量，防止系统雪崩。</p><p>此外，整套系统拥有分接口流控监控能力，可对流控效果进行监控，及时发现系统异常。整套方案在数次异常流量增长的故障中，经受住了考验。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="发布">发布<a class="hash-link" href="#发布" title="标题的直接链接">​</a></h2><p>随着外卖业务的发展，美团外卖的用户量和订单量已经达到了相当的量级，在线直接全量发布版本/功能影响范围大，风险高。</p><p>版本灰度和功能灰度是一种能够平滑过渡的发布方式：即在线上进行 A/B 实验，让一部分用户继续使用产品（特性）A，另一部分用户开始使用产品（特性）B。</p><p>如果各项指标平稳正常，结果符合预期，则扩大范围，将所有用户都迁移到 B 上来，否则回滚。</p><p>灰度发布可以保证系统的稳定，在初试阶段就可以发现问题，修复问题，调整策略，保证影响范围不被扩散。</p><p>美团外卖客户端在版本灰度及功能灰度已较为完善：</p><ul><li><p><strong>版本灰度，</strong>iOS 采用苹果官方提供的分阶段发布方式，Android 则采用美团自研的 EVA 包管理后台进行发布。这两类发布均支持逐步放量的分发方式。</p></li><li><p><strong>功能灰度，</strong>功能发布开关配置系统依据用户特征维度（如城市，用户 ID）发布，并且整个配置系统有测试和线上两套不同环境，配合固定的上线窗口，保证上线的规范性。</p></li></ul><p>对应的，相应的监控基础设施也支持分用户特征维度（如城市，用户 ID）监控，避免了那些无法在整体大盘体现的灰度异常。</p><p>此外，无论版本灰度或功能灰度，我们均有相应最小灰度周期和回滚机制，保证整个灰度发布过程可控，最小化问题影响。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="线上运维">线上运维<a class="hash-link" href="#线上运维" title="标题的直接链接">​</a></h2><p>在故障来临时如何应对，是整个质量保障体系中最关键的环节。没有人天生就能完美的处理紧急情况，面对问题，恰当的处理需要平时不断的演练。</p><p>围绕问题的生命周期，即发现、定位、解决（预防），美团外卖客户端团队组建了一套完备的处理流程和规范来应对影响链路稳定性的各类线上问题。</p><p>整体思路：建立规范，提前建设，有效应对，事后总结，如下图：</p><p><img loading="lazy" alt="Untitled" src="/assets/images/ebe8398c9f4cf3e1-577f8f0039b98b1d874239ed804b7f57.png" width="1080" height="527" class="img_ev3q"></p><p>在不同阶段用不同方式解决不同问题，事前确定完整的事故流程管理策略，并确保平稳实施，经常演练，问题的平均恢复时间大大降低，美团外卖核心链路的高稳定性才能够得以保障。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="未来展望">未来展望<a class="hash-link" href="#未来展望" title="标题的直接链接">​</a></h2><p>当前美团外卖业务仍然处于快速增长期。伴随着业务的发展，背后支持业务的技术系统也日趋复杂。</p><p>在美团外卖客户端高可用体系建设过程中，我们希望能够通过一套智能化运维系统，帮助工程师快速、准确的识别核心链路各子系统异常，发现问题根源。</p><p>并自动执行对应的异常解决预案，进一步缩短服务恢复时间，从而避免或减少线上事故影响。</p><p>诚然，业界关于自动化运维的探索有很多，但多数都集中在后台服务领域，前端方向成果较少。</p><p>我们外卖技术团队目前也在同步的探索中，正处于基础性建设阶段，欢迎更多业界同行跟我们一起讨论、切磋。</p><br><p><em>作者：陈航、富强<strong>、</strong>徐宏</em></p><p><em>简介：陈航，美团高级技术专家。2015 年加入美团，目前负责美团外卖 iOS 团队，对移动端架构演进，监控报警备份容灾，移动端线上运维等领域有深刻理解。</em></p><p><em>富强，美团资深工程师。2015 年加入美团，是外卖 iOS 的早期开发者之一，目前作为美团外卖 iOS 基础设施小组负责人，负责外卖基础设施及广告运营相关业务。</em></p><p><em>徐宏，美团高级工程师。2016 年加入美团，目前作为外卖 iOS 团队主力开发，负责移动端 APM 性能监控，高可用基础设施支撑相关推进工作。</em></p><br></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/science09/science09.github.io/tree/main/docs/notes/wechat/2000万日订单背后，如何保障系统的高可用？.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">最后<!-- -->由 <b>zhaofeng.luo</b> <!-- -->更新</span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文档分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/京东售后系统架构设计：专治多端并发、数据不一致的臭毛病"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">京东售后系统架构设计：专治多端并发、数据不一致的臭毛病</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/Docker 网络4种模式详解"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">Docker 网络4种模式详解</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#高可用建设体系的思路" class="table-of-contents__link toc-highlight">高可用建设体系的思路</a></li><li><a href="#美团外卖质量保障体系全景图" class="table-of-contents__link toc-highlight">美团外卖质量保障体系全景图</a></li><li><a href="#背景监控报警" class="table-of-contents__link toc-highlight">背景监控&amp;报警</a></li><li><a href="#日志体系" class="table-of-contents__link toc-highlight">日志体系</a></li><li><a href="#容灾备份" class="table-of-contents__link toc-highlight">容灾备份</a><ul><li><a href="#降级" class="table-of-contents__link toc-highlight"><strong>降级</strong></a></li><li><a href="#备份" class="table-of-contents__link toc-highlight"><strong>备份</strong></a></li><li><a href="#限流" class="table-of-contents__link toc-highlight"><strong>限流</strong></a></li></ul></li><li><a href="#发布" class="table-of-contents__link toc-highlight">发布</a></li><li><a href="#线上运维" class="table-of-contents__link toc-highlight">线上运维</a></li><li><a href="#未来展望" class="table-of-contents__link toc-highlight">未来展望</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">本站</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">个人笔记</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/notes-intro">技术文摘</a></li></ul></div><div class="col footer__col"><div class="footer__title">我的</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/science09" target="_blank" rel="noopener noreferrer" class="footer__link-item">Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">更多</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/">...</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?d8e6c589e01c3df834c9a1f32e0f9258";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script>
        
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        <span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span>  版权所有 © 2022  此网站使用 Docusaurus 构建。</div></div></div></footer></div>
<script src="/assets/js/runtime~main.b8772c3e.js"></script>
<script src="/assets/js/main.6900f799.js"></script>
</body>
</html>