<!doctype html>
<html lang="zh-Hans" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-notes/wechat/B站在全链路压测上的实践">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.1.0">
<title data-rh="true">B站在全链路压测上的实践 | 彼岸_未来</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://science09.github.io/docs/B站在全链路压测上的实践"><meta data-rh="true" name="docusaurus_locale" content="zh-Hans"><meta data-rh="true" name="docsearch:language" content="zh-Hans"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="B站在全链路压测上的实践 | 彼岸_未来"><meta data-rh="true" name="description" content="01 背景"><meta data-rh="true" property="og:description" content="01 背景"><link data-rh="true" rel="icon" href="/img/favicon.png"><link data-rh="true" rel="canonical" href="https://science09.github.io/docs/B站在全链路压测上的实践"><link data-rh="true" rel="alternate" href="https://science09.github.io/docs/B站在全链路压测上的实践" hreflang="zh-Hans"><link data-rh="true" rel="alternate" href="https://science09.github.io/docs/B站在全链路压测上的实践" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="彼岸_未来 RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="彼岸_未来 Atom Feed"><link rel="stylesheet" href="/assets/css/styles.e07c85a0.css">
<link rel="preload" href="/assets/js/runtime~main.44f2c2ee.js" as="script">
<link rel="preload" href="/assets/js/main.6900f799.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,e("light"))}()</script><div id="__docusaurus">
<div role="region" aria-label="跳到主要内容"><a href="#" class="skipToContent_fXgn">跳到主要内容</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="Logo" class="themedImage_ToTc themedImage--light_HNdA" style="border-radius:70%"><img src="/img/logo.svg" alt="Logo" class="themedImage_ToTc themedImage--dark_i4oU" style="border-radius:70%"></div><b class="navbar__title text--truncate">彼岸_未来</b></a><a class="navbar__item navbar__link" href="/blog">个人笔记</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/notes-intro">技术文摘</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/science09" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="切换浅色/暗黑模式（当前为浅色模式）" aria-label="切换浅色/暗黑模式（当前为浅色模式）"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="回到顶部" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/notes-intro">介绍</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/docs/分布式唯一 ID 生成方案">公众号文章</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/分布式唯一 ID 生成方案">分布式唯一 ID 生成方案</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/how_dose_linux_filesystem_work">Linux文件系统是如何工作的？</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/mysql_MVCC_and_its_implementation_principle">深入理解 MySQL 的 MVCC 及实现原理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/从0.742秒到0.006秒，MySQL百万数据深分页优化实战">从0.742秒到0.006秒，MySQL百万数据深分页优化实战</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/30条永不过时的SQL优化技巧">30条永不过时的SQL优化技巧</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/21个MySQL表设计的经验准则">21个MySQL表设计的经验准则</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/MySQL的普通索引和唯一索引到底什么区别？">MySQL的普通索引和唯一索引到底什么区别？</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/图文结合！Redis延迟队列golang高效实践">图文结合！Redis延迟队列golang高效实践</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/3种方式！Go Error处理最佳实践">3种方式！Go Error处理最佳实践</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/推荐系统 embedding 技术实践总结">推荐系统 embedding 技术实践总结</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Go几个黑魔法技巧汇总">Go几个黑魔法技巧汇总</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Redis详细介绍一篇就够">Redis详细介绍一篇就够</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/快速实现一个分布式定时器">快速实现一个分布式定时器</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/如何做架构设计和评审">如何做架构设计和评审</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/面试官：为什么说mysql数据库单表最大两千万？">面试官：为什么说mysql数据库单表最大两千万？</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/【系统设计】S3 对象存储">【系统设计】S3 对象存储</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/B站在全链路压测上的实践">B站在全链路压测上的实践</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/小红书KV存储架构：万亿级数据与跨云多活不在话下">小红书KV存储架构：万亿级数据与跨云多活不在话下</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/网易严选商品中心DDD实践">网易严选商品中心DDD实践</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/社区点赞业务缓存设计优化探索 ｜ 得物技术">社区点赞业务缓存设计优化探索 ｜ 得物技术</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/缓存高频面试题：缓存穿透？缓存击穿？缓存雪崩？">缓存高频面试题：缓存穿透？缓存击穿？缓存雪崩？</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/十几亿用户中心系统，ES+Redis+MySQL架构就轻松搞定！">十几亿用户中心系统，ES+Redis+MySQL架构就轻松搞定！</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/京东售后系统架构设计：专治多端并发、数据不一致的臭毛病">京东售后系统架构设计：专治多端并发、数据不一致的臭毛病</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/2000万日订单背后，如何保障系统的高可用？">2000万日订单背后，如何保障系统的高可用？</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/Docker 网络4种模式详解">Docker 网络4种模式详解</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/去哪儿网业务缓存体系的升级改造">去哪儿网业务缓存体系的升级改造</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/架构师技术路线图">架构师技术路线图</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/10年后，再审视Heroku发布的十二要素应用">10年后，再审视Heroku发布的十二要素应用</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/互联网公司常用分库分表方案汇总">互联网公司常用分库分表方案汇总</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="true" href="/docs/resources-webtool">资源</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/resources-webtool">工具网站列表</a></li></ul></li></ul></nav><button type="button" title="收起侧边栏" aria-label="收起侧边栏" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="页面路径"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="主页面" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">公众号文章</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">B站在全链路压测上的实践</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">本页总览</button></div><div class="theme-doc-markdown markdown"><header><h1>B站在全链路压测上的实践</h1></header><br><h2 class="anchor anchorWithStickyNavbar_LWe7" id="01-背景"><strong>01 背景</strong><a class="hash-link" href="#01-背景" title="标题的直接链接">​</a></h2><p>全链路压测是在线上生产环境中通过模拟正常用户操作路径进行压力测试的一种方式，对比于我们通常的接口压测具有仿真度高、场景覆盖全等特点。过去的几年里，阿里、美团、字节等大厂均有一系列的实践技术文章进行分享公开，更有PTS全链路压测、XSea全链路压测平台、Takin全链路压测平台等商业化解决方案。站在巨人们的肩膀上，本文将基于这些成熟的实践经验并结合 B 站的基础设施来介绍我们在全链路压测的建设和落地经验。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="02-方案选择"><strong>02 方案选择</strong><a class="hash-link" href="#02-方案选择" title="标题的直接链接">​</a></h2><p>我们首先看看实施全链路压测需要具备哪些能力？整体分为两部分：基础压测能力、全链路压测能力</p><p>基础压测能力是我们实施压测的核心依赖，在<a href="http://mp.weixin.qq.com/s?__biz=Mzg3Njc0NTgwMg==&amp;mid=2247486677&amp;idx=1&amp;sn=46325046c76586d566ad1291ae12c2cb&amp;chksm=cf2cc9f0f85b40e6e8e8a6f0cedb396382afcf5a4ccbb729c13962109de0bfd182008d0e63fe&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">《B站压测实践之压测平台的演进》</a>一文中已有介绍，核心要实现三大能力：发压能力、压测场景编辑、压测数据管理，幸运的是这些已经被我们的 Melloi 压测平台解决。</p><p>全链路压测能力是我们的压测目标对象和压测平台需要同时具备的一种能力，其核心在于全链路这三个字，进一步讲是全链路标识传递和数据隔离这两种能力。</p><p>为什么是全链路标识传递和数据隔离这两种能力？回到全链路压测的定义（在生产环境的实施的场景化压测）避免不了用户写入场景的压测，这会对生产环境产生脏数据。为了解决这个问题引入了压测标识传递和数据隔离这两种能力的需求。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="全链路标识传递"><strong>全链路标识传递</strong><a class="hash-link" href="#全链路标识传递" title="标题的直接链接">​</a></h3><p>定义一种压测标识，并将这个标识在压测过程中沿着请求链路一直传递下去。这就是全链路标识传递需要实现的功能。</p><p>我们将压测标识定义为字符串，其取值为压测场景ID。场景 ID 关联了一个特定的压测场景，因为我们发现不同的场景下压测所需要覆盖的服务范围、压测配置会存在差异。</p><p><strong>请求间的标识传递</strong></p><p>请求间的标识传递属于 RPC 协议规范的一部分，需要在服务框架中实现客户端设置标识、请求传递标识、服务端读取标识三部分。B 站内部服务间主要是通过 HTTP / GRPC 协议进行通信，对于这两种协议我们约定了压测标识的传递格式如下（示例）：</p><p><img loading="lazy" alt="Untitled" src="/assets/images/c83f8607a3178ef6-897f825a2ac19742bd672fab3ccc920f.png" width="1080" height="447" class="img_ev3q"></p><p>同时在常用服务框架层面已支持标识的读取和写入，即从上下文取得标识并设置请求、从请求中取得标识并设置到上下文。</p><p><strong>服务内的标识传递</strong></p><p>业务服务在收到携带标识的请求后，在业务逻辑处理中需要将标识一直携带下去，如业务逻辑中的 RPC 请求、数据库访问、缓存访问、日志写入等等。如何在请求维度去传递标识不同的语言有不同的实现。我们以最常用的两种语言 JAVA 和 Go 举例：</p><p><img loading="lazy" alt="Untitled" src="/assets/images/28883f0b7acb4546-b869c108a38eaad7c9c593817d672ed6.png" width="1063" height="378" class="img_ev3q"></p><p><strong>异步场景的标识传递</strong></p><p>这里的异步场景指常见的生产消费模型，即通过消息队列进行交互的场景。我们有两种方式来处理异步场景的标识传递。</p><p>方法1：影子队列模式，即在应用程序中识别到压测标识后将消息投递到另一个队列中。消息本身不再携带压测标识，而是通过队列名称进行区分。消费者需要同时消费正常队列和影子队列，对于影子队列使用上文提到的 服务内标识传递技术进行传递。</p><p>方法2：在消息数据结构中封装 metadata 信息，并通过 metadata 传递压测标识。对于消费者而言将会在同一个队列收到正常业务消息和携带压测标识的业务消息。业务服务在读取到携带压测标识的消息后需要构建携带标识的 Context 用于应用内标识传递。</p><p>两种方法各有其优缺点，也需要业务服务进行适配改造。</p><p><strong>定时任务的标识传递</strong></p><p>定时任务不同于业务请求，是通过时间触发而不是一个外部请求，因此无法传入标识。对于定时任务需要业务程序同时创建两个定时任务，一个是普通的业务任务，一个是用于处理压测数据的影子任务，对于影子任务可以通过配置文件管理需要注入上下文的压测标识。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="数据隔离"><strong>数据隔离</strong><a class="hash-link" href="#数据隔离" title="标题的直接链接">​</a></h3><p>为了在全链路压测中不造成数据污染，所有涉及数据读写的场景需要针对携带压测标识的流量进行数据隔离操作。为此我们定义 4 种规则类型分别为：</p><p><img loading="lazy" alt="Untitled" src="/assets/images/99b0b390122e9935-854d41001db35fef8b49f793d4a087e2.png" width="875" height="358" class="img_ev3q"></p><p>4种规则分别对应于不同场景下对压测流量的处理方式。其中 passthrough 和 drop 实现比较简单，我们重点讲一下 mock 和 mirror 如何实现。</p><p><strong>mock</strong></p><p>即我们常说的 mock 服务器，在实施全链路压测中有以下几种常见需要通过 mock 服务器实现：</p><ol><li><p>外部的服务依赖，通常是无法支持全链路压测的第三方服务需要通过mock 的方式使压测请求能够按照普通请求的业务流程处理完成。</p></li><li><p>控制压测流量的作用范围，对于在业务请求的依赖链路中但不想参与到该场景的服务或暂时无法满足要求的服务可以通过 mock 方式使压测的主场景能完整走通。</p></li></ol><p><strong>mirror</strong></p><p>mirror 又叫镜像、影子，其本质是从存储角度将普通业务流量产生的数据和压测流量产生的数据区别开。对于我们常用的存储组件通常有这样一些方案可供选择：</p><p>数据库：一般来说有影子库和影子表两种方案，影子库顾名思义是将压测流量路由到另一个同构的数据库实例上；影子表则是通过 SQL PARSE 将实际执行的 SQL 改写为同构的影子表，影子表通常是通过添加特定前缀的数据表，其表结构与原表完全一致。</p><p>缓存: 通常采用影子 Key 的实现方式，与数据库的影子表模式基本一致，即将压测流量操作的 key 添加特定前缀的方案。</p><p>消息队列：采用影子队列的方式，带有压测标识的消息将被发送到影子 TOPIC ，由对应的影子消费者进行数据消费。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="03-系统设计"><strong>03 系统设计</strong><a class="hash-link" href="#03-系统设计" title="标题的直接链接">​</a></h2><p>系统设计需要考虑真实业务场景的复杂度，以及尽可能减少业务在适配全链路压测过程中的改造成本。因此我们把 90% 场景对全链路压测的支持都通过基础库透明实现，业务只需要引入全链路压测 SDK 即可。同时设计了足够灵活的配置系统，进一步减少业务的在支持全链路压测的成本。</p><p><img loading="lazy" alt="Untitled" src="/assets/images/5404fca7d61b59ab-55552332f928c2a8f2d2b8500a3f3dcb.png" width="1080" height="844" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="全链路压测配置管理"><strong>全链路压测配置管理</strong><a class="hash-link" href="#全链路压测配置管理" title="标题的直接链接">​</a></h3><p>配置管理需要管什么？我们可以从服务角度从外向内逐层解析。</p><p><img loading="lazy" alt="Untitled" src="/assets/images/b42374b19bca2b3f-85ea05e394fb38c9439319c56089c6a5.png" width="912" height="652" class="img_ev3q"></p><p><strong>Service</strong>：服务维度有全局压测开关，用于控制该服务是否接受压测流量。可以在压测异常的情况下通过开关快速拒绝压测流量，使服务回归正常状态。</p><p><strong>RPC/HTTP</strong>：请求维度，分为服务接口和依赖服务接口，分别是服务对外提供的接口和依赖服务的接口。可以从接口维度控制压测流量的准入和禁止，我们称为传入接口控制，支持了 passthrough 和 drop 两种行为。而依赖服务接口配置则控制了服务调用其他服务时的表现，我们称为传出接口控制，支持了 passthrough/drop/mock 三种行为。</p><p><strong>Database/Queue/Cache</strong>：三类我们可以统称为数据层的压测流量控制，也是全链路压测中数据隔离的关键部分。</p><p><img loading="lazy" alt="Untitled" src="/assets/images/d0d447a2f2e995b1-a127544faa39047f7a88181e2943ec9c.png" width="872" height="387" class="img_ev3q"></p><p>以上配置我们统称为服务全链路压测的基准配置，在基准配置之上我们还设计了一层场景配置。所谓的场景配置是针对一个具体的业务场景关联的全链路压测配置集合，场景是由一个或多个服务构成的集合，场景内的服务需要支持全链路压测，在场景所包含的请求链路上但不在圈定场景内的服务则默认不接受压测流量。通过场景概念的抽象，我们控制了全链路压测的流量范围，实现精准的流量控制。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="链路分析器"><strong>链路分析器</strong><a class="hash-link" href="#链路分析器" title="标题的直接链接">​</a></h3><p>链路分析器以 Dapper 记录的 Trace 信息作为数据源，在全链路压测中提供以下功能：</p><ol><li><p>业务场景调用链分析：如依赖服务、依赖接口，基于这些信息来圈定待压测的服务范围，对范围内的服务需要支持全链路压测，范围外的服务或接口可通过 drop 或 mock 隔离压测流量。</p></li><li><p>业务依赖组件分析：分析服务使用的缓存、数据库资源，作为后续全链路压测配置的参考，以及准备对应的影子表创建和数据预装。</p></li><li><p>全链路标识覆盖率分析：验证压测标识是否在整个链路完整传递。</p></li><li><p>全链路配置覆盖率分析：通过链路压测调试验证配置完整覆盖整个请求链路。</p></li></ol><p><img loading="lazy" alt="Untitled" src="/assets/images/260c6e2c69f8e79d-dc2c7410962bc14b400a661ca98f0cef.png" width="1080" height="401" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="mock-server"><strong>Mock Server</strong><a class="hash-link" href="#mock-server" title="标题的直接链接">​</a></h3><p>Mock Server 已有非常多的候选项，可以根据熟悉程度选择合适的开源产品或自建 mock 服务。我们在实现上对 mock server 的支持是通过嵌入 SDK 的方式实现，即通过服务框架的拦截器将命中的压测请求转发到指定的 mock 服务上。特别注意的是 mock server 需要支持动态返回，即根据请求的参数动态生成返回的数据，因为在真实业务场景中返回数据通常是跟请求数据相关联的，如 UID 匹配、数据下标对应等等。同时还需要支持对平均耗时、99分位耗时的模拟以更贴近真正的请求场景。</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="全链路压测-sdk"><strong>全链路压测 SDK</strong><a class="hash-link" href="#全链路压测-sdk" title="标题的直接链接">​</a></h3><p>我们这里以 Golang 语言为例简要说明基础库在 SDK 改造中的要点。</p><ol><li><p>无侵入性，所有对全链路压测的支持均在基础库实现，业务只需要使用基础库提供的标准组件即可，如 ORM库、Redis Client 等等。</p></li><li><p>无 Breaking Change，SDK 接入前后对正常业务流量无影响，任何时候规则处理仅针对压测流量，不影响正常用户请求。</p></li><li><p>保底安全策略，即在 无配置或压测配置服务异常情况下，业务服务默认以安全的方式处理压测流量，不产生脏数据。</p></li></ol><p><strong>主要组件的改造思路</strong>：</p><ol><li><p>MySQL：我们采用的影子表方案，采用了pingcap 开源的 SQL Parser 对 SQL 进行解析和重新通过规则匹配将 SQL 操作的数据表改写为对应的影子表。</p></li><li><p>Cache : 主要是 Redis 和 Memcache，需要注意的是Redis 的命令非常多且不同命令的 Key 参数位置和数量也有差异，需要根据不用的命令作对应的重写处理。</p></li><li><p>GRPC: 分为 Client 和 Server，通过 Interceptor 机制实现拦截器即可，客户端和服务端均支持拦截器模式。</p></li><li><p>HTTP：与GRPC 类似地实现拦截器机制。</p></li><li><p>Queue：分为生产和消费者，SDK 同时建立正常的消息通道和影子消息通道，基于配置将消息投递到对应的通道。</p></li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="基础平台支持"><strong>基础平台支持</strong><a class="hash-link" href="#基础平台支持" title="标题的直接链接">​</a></h3><p>完备、顺畅的全链路压测实施不仅需要压测平台和业务的支持，还需要公司现有的基础平台的配合实现，这里列举了我们在全链路压测实施中对既有平台的改造适配。</p><p>数据库平台：支持影子表的管理，一键创建、清理影子表，影子表数据包管理，可维护不同压测场景的影子表数据包，支持一键载入场景数据包到影子表。</p><p>消息队列平台：支持影子队列生产、消费的快速创建。</p><p>缓存平台：支持对影子 Key 的快速清理，便于压测后缓存空间的快速回收。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="04-业务改造"><strong>04 业务改造</strong><a class="hash-link" href="#04-业务改造" title="标题的直接链接">​</a></h2><p>业务改造分为三部分：</p><p><strong>1. 全链路压测 SDK 接入</strong></p><p>我们实现了一行代码接入的方式，这部分的成本是最低的。</p><div class="language-plain codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plain codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">import &quot;go-common/library/mirror/mirroragent&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mirroragent.Init(nil)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">defer mirroragent.Close()</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>2. 特殊场景的适配</strong></p><p>除了上述提到的 请求/响应、生产/消费场景外，还存在定时任务场景，这部分我们也通过组件封装的形式将改造成本降为一行代码。</p><div class="language-plain codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-plain codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cron.AddFunc(&quot;@every 15s&quot;, fun1, &quot;loaddata&quot;, cronUtil.PreLoad())  //原JOB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">cron.AddFunc(&quot;@every 15s&quot;, fun1, &quot;loaddata&quot;, cronUtil.PreLoad(),cronUtil.Mirror(&quot;mirrorId&quot;)) //新增影子JOB</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="复制代码到剪贴板" title="复制" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>3. 不兼容历史代码改造</strong></p><p>这部分是业务改造的难点、痛点部分，对于 Golang 而言最大的问题是 Context 的规范使用，我们已经知道全链路压测标识传递依赖于 Context 在应用内和应用间的传递。为了快速识别业务代码中 Context 中断的场景，我们开发了 Context lint 工具。不同于通常的基于 AST 的lint 工具实现，在深入分析 Golang 编译过程后我们基于 SSA 实现了调用链的 Context 中断检查，支持了以下模式：</p><ol><li><p>检查 ctx 是否为函数的第一个入参。</p></li><li><p>检查是否在有 ctx 传入的函数中使用了 log.Info、log.Warn、log.Error。</p></li><li><p>检查是否在有 ctx 传入的函数中使用了非继承的新 ctx。</p></li><li><p>检查是否在有 ctx 传入的函数中调用了无需传递 ctx 的子函数，但是在子函数中又需要使用 ctx。</p></li></ol><p>目前该 lint 已开源并集成到 Golangci-lint 中。</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="05-压测实施"><strong>05 压测实施</strong><a class="hash-link" href="#05-压测实施" title="标题的直接链接">​</a></h2><p>为了指导业务顺利实施全链路压测，我们把整个过程我们总结为了 8 个步骤，并针对每个步骤提供了对应的指导手册和平台使用指南以便业务顺利实施全链路压测。</p><p><img loading="lazy" alt="Untitled" src="/assets/images/9a3f77f28c142d0f-876ed0216d308a8e10b72f46550a56b2.png" width="814" height="604" class="img_ev3q"></p><p>业务在接入全链路压测后，通过全链路压测能力在线上真实环境压测发现了10+ 线上问题，如配置错误、慢查询、锁冲突等等。以直播营收系统为例，在同等资源下对压测发现的瓶颈点优化后系统 TPS 提升 140%，有效地保障了大型活动中服务的稳定性。</p><br><p><strong>参考资料</strong></p><p>[1]<!-- --> 阿里怎么做双 11 全链路压测？(<a href="https://www.infoq.cn/article/xe6durkfvpxk20c5egosa" target="_blank" rel="noopener noreferrer">https://www.infoq.cn/article/xe6durkfvpxk20c5egosa</a>)</p><p>[2]<!-- --> 字节跳动全链路压测 (Rhino) 的实践 (<a href="https://www.infoq.cn/article/O9i6BfecBm3TI5htfM1r/" target="_blank" rel="noopener noreferrer">https://www.infoq.cn/article/O9i6BfecBm3TI5htfM1r/</a>)</p><p>[3]<!-- --> 首款生产环境全链路压测平台——Takin开源啦！(<a href="https://news.shulie.io/?p=3024" target="_blank" rel="noopener noreferrer">https://news.shulie.io/?p=3024</a>)</p><p>[4]<!-- --> CRISP: Critical Path Analysis for Microservice Architectures (<a href="https://eng.uber.com/crisp-critical-path-analysis-for-microservice-architectures/" target="_blank" rel="noopener noreferrer">https://eng.uber.com/crisp-critical-path-analysis-for-microservice-architectures/</a>)</p><p>[5]<!-- --> <a href="https://golangci-lint.run/usage/linters/" target="_blank" rel="noopener noreferrer">https://golangci-lint.run/usage/linters/</a></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/science09/science09.github.io/tree/main/docs/notes/wechat/B站在全链路压测上的实践.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>编辑此页</a></div><div class="col lastUpdated_vwxv"><span class="theme-last-updated">最后<!-- -->由 <b>zhaofeng.luo</b> <!-- -->更新</span></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="文档分页导航"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/【系统设计】S3 对象存储"><div class="pagination-nav__sublabel">上一页</div><div class="pagination-nav__label">【系统设计】S3 对象存储</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/小红书KV存储架构：万亿级数据与跨云多活不在话下"><div class="pagination-nav__sublabel">下一页</div><div class="pagination-nav__label">小红书KV存储架构：万亿级数据与跨云多活不在话下</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#01-背景" class="table-of-contents__link toc-highlight"><strong>01 背景</strong></a></li><li><a href="#02-方案选择" class="table-of-contents__link toc-highlight"><strong>02 方案选择</strong></a><ul><li><a href="#全链路标识传递" class="table-of-contents__link toc-highlight"><strong>全链路标识传递</strong></a></li><li><a href="#数据隔离" class="table-of-contents__link toc-highlight"><strong>数据隔离</strong></a></li></ul></li><li><a href="#03-系统设计" class="table-of-contents__link toc-highlight"><strong>03 系统设计</strong></a><ul><li><a href="#全链路压测配置管理" class="table-of-contents__link toc-highlight"><strong>全链路压测配置管理</strong></a></li><li><a href="#链路分析器" class="table-of-contents__link toc-highlight"><strong>链路分析器</strong></a></li><li><a href="#mock-server" class="table-of-contents__link toc-highlight"><strong>Mock Server</strong></a></li><li><a href="#全链路压测-sdk" class="table-of-contents__link toc-highlight"><strong>全链路压测 SDK</strong></a></li><li><a href="#基础平台支持" class="table-of-contents__link toc-highlight"><strong>基础平台支持</strong></a></li></ul></li><li><a href="#04-业务改造" class="table-of-contents__link toc-highlight"><strong>04 业务改造</strong></a></li><li><a href="#05-压测实施" class="table-of-contents__link toc-highlight"><strong>05 压测实施</strong></a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">本站</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/blog">个人笔记</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/notes-intro">技术文摘</a></li></ul></div><div class="col footer__col"><div class="footer__title">我的</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/science09" target="_blank" rel="noopener noreferrer" class="footer__link-item">Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">更多</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/">...</a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?d8e6c589e01c3df834c9a1f32e0f9258";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script>
        
        <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
        <span id="busuanzi_container_site_pv">本站总访问量<span id="busuanzi_value_site_pv"></span>次</span>  版权所有 © 2022  此网站使用 Docusaurus 构建。</div></div></div></footer></div>
<script src="/assets/js/runtime~main.44f2c2ee.js"></script>
<script src="/assets/js/main.6900f799.js"></script>
</body>
</html>